<!doctype html>
<html lang="en">
<meta charset="utf-8">
<title>Intro to Contrast-O-Vision</title>
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,shrink-to-fit=no">

<link rel="stylesheet" href="./site.css">
<link rel="stylesheet" href="./intro.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Sarina&text=Complext">

<h1>
  <svg viewBox="0 0 90 15" role="presentation">
    <text y="14" dx="0 0 0 0 0 0 0 0 -2 0 0 -1" textLength="90"
      lengthAdjust="spacingAndGlyphs">Contrast-O-Vision</text>
  </svg>
</h1>

<main>
  <div class="intro">
    <p>
      Sick of copy/pasting color codes for accessible contrast checking?
      <b>You’ve come to the right place.</b>
    </p>

    <p>
      Put a URL in that bar up ↑ thar,
      and see accessible contrast before your very eyes &mdash; in real time!
      If your browser can render it, you can check it:
    </p>
  </div>

  <table class="examples">
    <thead>
      <tr>
        <th scope="col">Before</th>
        <th scope="col">After</th>
      </tr>
    </thead>

    <tr>
      <td class="example example--background">Complex<br>backgrounds</td>
      <td class="example example--background filtered">Complex<br>backgrounds</td>
    </tr>

    <tr>
      <td class="example example--text">
        <svg role="presentation" viewBox="0 0 340 140" width="320" height="140">
          <linearGradient id="fadient">
            <stop stop-opacity="0.05"/>
            <stop offset=".5"/>
            <stop offset="1" stop-opacity="0.05"/>
          </linearGradient>

          <pattern id="pattern2" width="40" height="40" viewBox="0 0 4 4"
                   patternUnits="userSpaceOnUse" patternTransform="rotate(45)">
            <path fill="url(#fadient)" d="m0 0h4v4H0"/>
          </pattern>

          <text x="50%" y="1em" fill="url(#pattern2)"
            font-size="60" font-family="Sarina" text-anchor="middle">
            Complex <tspan x="50%" dy="1em">text</tspan>
          </text>
        </svg>
      </td>
      <td class="example example--text filtered">
        <svg role="presentation" viewBox="0 0 340 140" width="320" height="140">
          <text x="50%" y="1em" fill="url(#pattern2)"
            font-size="60" font-family="Sarina" text-anchor="middle">
            Complex <tspan x="50%" dy="1em">text</tspan>
          </text>
        </svg>
      </td>
    </tr>

    <tr>
      <td class="example"><p class="example--animation">Animation</p></td>
      <td class="example filtered"><p class="example--animation">Animation</p></td>
    </tr>

    <tr>
      <td class="example example--dynamic">
        <select class="example--dynamic__select">
          <option>Dynamic content</option>
          <option>Editable content</option>
          <option>Any content!</option>
        </select>
      </td>
      <td class="example example--dynamic filtered">
        <select class="example--dynamic__select">
          <option>Dynamic content</option>
          <option>Editable content</option>
          <option>Any content!</option>
        </select>
      </td>
    </tr>
  </table>
</main>

<svg height="1" width="1" class="filter-svg">
  <filter id="contrast-o-vision"
          color-interpolation-filters="linearRGB"
          x="0" y="0" width="1" height="1"> <!-- set filter area to filtered element's dimensions -->

    <!-- STEP 1: Convert each pixel based on its luminance

         This feColorMatrix shorthand converts each pixel to rgba(0,0,0, X), where X is the pixel's luminance. This should match the official WCAG algorithm: https://www.w3.org/TR/WCAG20/relative-luminance.xml

         The first operation in the WCAG algorithm when each color component is ≤0.03928 appears to be the conversion from sRGB to linear RGB, so as long as we specify `color-interpolation-filters="linearRGB"` like above, this should be equivalent.
      -->
    <feColorMatrix in="SourceGraphic"
                   type="luminanceToAlpha"
                   result="LUMINANCE"/>

    <!-- Possible tweak: slight blur to iron out irregularities -->

    <!-- STEP 2: Find high-contrast edges between pixel luminances

         This particular convolution matrix kernel is known as an "Edge Detect", which you may have used in a graphics editor. It displays lines more vividly when the difference between two adjacent pixels is high.

         It would be nice to know if it can be tweaked to exaggerate/soften its output.

         Other possible matrices:
           kernelMatrix=" 1 -2  1
                         -2  4 -2
                          1 -2  1"


    -->
    <feConvolveMatrix in="LUMINANCE"
                      kernelMatrix="1  1  1
                                    1 -8  1
                                    1  1  1"
                      result="EDGES"/>

    <!-- STEP 3: Hide all edges too faint to meet contrast requirements

        This filter operation should "round" each pixel to either full opacity or full transparency, depending on which one it's closer to. Edges too faint to match the WCAG requirements should disappear. -->
    <feComponentTransfer in="EDGES"
                         result="VALID_EDGES">
      <feFuncA type="discrete"
               tableValues="0 1"/> <!-- Locks opacity to either 0 or 1 -->
    </feComponentTransfer>

    <!-- Change the black pixels to be green instead -->
    <feColorMatrix in="VALID_EDGES"
                   type="matrix"
                   values="1  0  0  0  -1
                           0  1  0  0   0.8
                           0  0  1  0   0.2
                           0  0  0  1   0"
                   result="INVERTED_VALID_EDGES"/>


    <!-- Generate a very dark overlay color -->
    <feFlood flood-color="rgba(0, 0, 0, 0.92)"
             result="PARTIALLY_TRANSPARENT_BLACK"/>

    <!-- Mix that color with the original image, producing a dimmed version -->
    <feBlend in="PARTIALLY_TRANSPARENT_BLACK"
             in2="SourceGraphic"
             result="DIMMED_ORIGINAL_ELEMENT"/>

    <!-- Overlay the edges on top of the dimmed element -->
    <feMerge>
      <feMergeNode in="DIMMED_ORIGINAL_ELEMENT"/>
      <feMergeNode in="INVERTED_VALID_EDGES"/>
    </feMerge>
  </filter>
</svg>

<script>
  document.querySelector('.toggle-btn').addEventListener('click', function() {
    var pressed = this.getAttribute('aria-pressed') === 'false';
    document.body.classList.toggle('contrast-o-vision--on');

    this.setAttribute('aria-pressed', pressed ? 'true' : 'false');
    this.innerText = pressed ?
      'Turn off Contrast-O-Vision' :
      'Turn on Contrast-O-Vision';
  });
</script>
